<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/cl/duoc/maestranza_v2/data/model/ApiDtos.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/cl/duoc/maestranza_v2/data/model/ApiDtos.kt" />
              <option name="originalContent" value="package cl.duoc.maestranza_v2.data.model&#10;&#10;import com.google.gson.annotations.SerializedName&#10;&#10;// ==================== AUTH DTOs ====================&#10;&#10;data class LoginRequest(&#10;    val username: String,&#10;    val password: String&#10;)&#10;&#10;data class JwtResponse(&#10;    val token: String,&#10;    val type: String,&#10;    val id: Long,&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val roles: List&lt;String&gt;,&#10;    val activo: Boolean&#10;)&#10;&#10;data class SignupRequest(&#10;    val username: String,&#10;    val email: String,&#10;    val password: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;data class MessageResponse(&#10;    val message: String&#10;)&#10;&#10;// ==================== PRODUCTO DTOs ====================&#10;&#10;data class ProductoDTO(&#10;    val id: Long,&#10;    val codigo: String,&#10;    val nombre: String,&#10;    val descripcion: String? = null,&#10;    val stock: Int,&#10;    val imageUrl: String? = null,&#10;    val fechaIngreso: String? = null,&#10;    val ubicacion: String? = null,&#10;    val activo: Boolean = true,&#10;    val umbralStock: Int? = null,&#10;    val categoriaId: Long? = null,&#10;    val categoria: CategoriaDTO? = null,&#10;    val precio: Double? = null,&#10;    val precioActual: Double? = null&#10;)&#10;&#10;// ==================== CATEGORIA DTOs ====================&#10;&#10;data class CategoriaDTO(&#10;    val id: Long,&#10;    val nombre: String,&#10;    val descripcion: String? = null&#10;)&#10;&#10;// ==================== MOVIMIENTO DTOs ====================&#10;&#10;data class MovimientoDTO(&#10;    val id: Long,&#10;    val fecha: String,&#10;    val usuarioId: Long,&#10;    val usuario: UsuarioDTO? = null,&#10;    val productoId: Long,&#10;    val producto: ProductoDTO? = null,&#10;    val cantidad: Int,&#10;    val tipo: String, // &quot;ENTRADA&quot; o &quot;SALIDA&quot;&#10;    val descripcion: String? = null,&#10;    val productoCodigo: String? = null,&#10;    val productoNombre: String? = null,&#10;    val imagePath: String? = null&#10;)&#10;&#10;data class CrearMovimientoRequest(&#10;    val productoId: Long,&#10;    val cantidad: Int,&#10;    val tipo: String, // &quot;ENTRADA&quot; o &quot;SALIDA&quot;&#10;    val descripcion: String? = null&#10;)&#10;&#10;// ==================== USUARIO DTOs ====================&#10;&#10;data class UsuarioDTO(&#10;    val id: Long,&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val activo: Boolean,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;data class ActualizarUsuarioDTO(&#10;    val email: String? = null,&#10;    val nombre: String? = null,&#10;    val apellido: String? = null,&#10;    val roles: List&lt;String&gt;? = null&#10;)&#10;&#10;data class CrearUsuarioDTO(&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val password: String,&#10;    val activo: Boolean = true,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;// ==================== ROL DTOs ====================&#10;&#10;data class RolDTO(&#10;    val id: Int,&#10;    val nombre: String // &quot;ROLE_ADMINISTRADOR&quot;, etc.&#10;)&#10;&#10;// ==================== ALERTA DTOs ====================&#10;&#10;data class AlertaDTO(&#10;    val id: Long,&#10;    val nombre: String,&#10;    val descripcion: String? = null,&#10;    val fecha: String,&#10;    val activo: Boolean,&#10;    val productoId: Long? = null,&#10;    val productoCodigo: String? = null,&#10;    val productoNombre: String? = null,&#10;    val productoStock: Int? = null,&#10;    val productoUmbralStock: Int? = null,&#10;    val productoUbicacion: String? = null,&#10;    val categoriaNombre: String? = null,&#10;    val tiempoTranscurrido: String? = null,&#10;    val nivelUrgencia: String? = null,&#10;    val resumenCorto: String? = null&#10;)&#10;&#10;// ==================== HISTORIAL PRECIOS DTOs ====================&#10;&#10;data class HistorialPreciosDTO(&#10;    val id: Long,&#10;    val precio: Double,&#10;    val fechaCreacion: String,&#10;    val productoId: Long&#10;)&#10;&#10;" />
              <option name="updatedContent" value="package cl.duoc.maestranza_v2.data.model&#10;&#10;import com.google.gson.annotations.SerializedName&#10;&#10;// ==================== AUTH DTOs ====================&#10;&#10;data class LoginRequest(&#10;    val username: String,&#10;    val password: String&#10;)&#10;&#10;data class JwtResponse(&#10;    val token: String,&#10;    val type: String,&#10;    val id: Long,&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val roles: List&lt;String&gt;,&#10;    val activo: Boolean&#10;)&#10;&#10;data class SignupRequest(&#10;    val username: String,&#10;    val email: String,&#10;    val password: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;data class MessageResponse(&#10;    val message: String&#10;)&#10;&#10;// ==================== PRODUCTO DTOs ====================&#10;&#10;data class ProductoDTO(&#10;    val id: Long,&#10;    val codigo: String,&#10;    val nombre: String,&#10;    val descripcion: String? = null,&#10;    val stock: Int,&#10;    val imageUrl: String? = null,&#10;    val fechaIngreso: String? = null,&#10;    val ubicacion: String? = null,&#10;    val activo: Boolean = true,&#10;    val umbralStock: Int? = null,&#10;    val categoriaId: Long? = null,&#10;    val categoria: CategoriaDTO? = null,&#10;    val precio: Double? = null,&#10;    val precioActual: Double? = null&#10;)&#10;&#10;// ==================== CATEGORIA DTOs ====================&#10;&#10;data class CategoriaDTO(&#10;    val id: Long,&#10;    val nombre: String,&#10;    val descripcion: String? = null&#10;)&#10;&#10;// ==================== MOVIMIENTO DTOs ====================&#10;&#10;data class MovimientoDTO(&#10;    val id: Long,&#10;    val fecha: String,&#10;    val usuarioId: Long,&#10;    val usuario: UsuarioDTO? = null,&#10;    val productoId: Long,&#10;    val producto: ProductoDTO? = null,&#10;    val cantidad: Int,&#10;    val tipo: String, // &quot;ENTRADA&quot; o &quot;SALIDA&quot;&#10;    val descripcion: String? = null,&#10;    val productoCodigo: String? = null,&#10;    val productoNombre: String? = null,&#10;    val imagePath: String? = null&#10;)&#10;&#10;data class CrearMovimientoRequest(&#10;    val productoId: Long,&#10;    val cantidad: Int,&#10;    val tipo: String, // &quot;ENTRADA&quot; o &quot;SALIDA&quot;&#10;    val descripcion: String? = null&#10;)&#10;&#10;// ==================== USUARIO DTOs ====================&#10;&#10;data class UsuarioDTO(&#10;    val id: Long,&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val activo: Boolean,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;data class ActualizarUsuarioDTO(&#10;    val email: String? = null,&#10;    val nombre: String? = null,&#10;    val apellido: String? = null,&#10;    val roles: List&lt;String&gt;? = null&#10;)&#10;&#10;data class CrearUsuarioDTO(&#10;    val username: String,&#10;    val email: String,&#10;    val nombre: String,&#10;    val apellido: String,&#10;    val password: String,&#10;    val roles: List&lt;String&gt;&#10;)&#10;&#10;// ==================== ROL DTOs ====================&#10;&#10;data class RolDTO(&#10;    val id: Int,&#10;    val nombre: String // &quot;ROLE_ADMINISTRADOR&quot;, etc.&#10;)&#10;&#10;// ==================== ALERTA DTOs ====================&#10;&#10;data class AlertaDTO(&#10;    val id: Long,&#10;    val nombre: String,&#10;    val descripcion: String? = null,&#10;    val fecha: String,&#10;    val activo: Boolean,&#10;    val productoId: Long? = null,&#10;    val productoCodigo: String? = null,&#10;    val productoNombre: String? = null,&#10;    val productoStock: Int? = null,&#10;    val productoUmbralStock: Int? = null,&#10;    val productoUbicacion: String? = null,&#10;    val categoriaNombre: String? = null,&#10;    val tiempoTranscurrido: String? = null,&#10;    val nivelUrgencia: String? = null,&#10;    val resumenCorto: String? = null&#10;)&#10;&#10;// ==================== HISTORIAL PRECIOS DTOs ====================&#10;&#10;data class HistorialPreciosDTO(&#10;    val id: Long,&#10;    val precio: Double,&#10;    val fechaCreacion: String,&#10;    val productoId: Long&#10;)&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/app/src/main/java/cl/duoc/maestranza_v2/viewmodel/UsersViewModel.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/cl/duoc/maestranza_v2/viewmodel/UsersViewModel.kt" />
              <option name="originalContent" value="package cl.duoc.maestranza_v2.viewmodel&#10;&#10;import android.content.Context&#10;import android.util.Log&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import cl.duoc.maestranza_v2.data.model.User&#10;import cl.duoc.maestranza_v2.data.model.UserFilters&#10;import cl.duoc.maestranza_v2.data.model.UserStatusFilter&#10;import cl.duoc.maestranza_v2.data.model.toUser&#10;import cl.duoc.maestranza_v2.data.model.CrearUsuarioDTO&#10;import cl.duoc.maestranza_v2.data.remote.ApiClient&#10;import cl.duoc.maestranza_v2.data.repository.Result&#10;import cl.duoc.maestranza_v2.data.repository.UsersRepository&#10;import cl.duoc.maestranza_v2.data.repository.RolesRepository&#10;import kotlinx.coroutines.FlowPreview&#10;import kotlinx.coroutines.flow.*&#10;import kotlinx.coroutines.launch&#10;&#10;@OptIn(FlowPreview::class)&#10;class UsersViewModel(context: Context? = null) : ViewModel() {&#10;&#10;    data class UsersUiState(&#10;        val users: List&lt;User&gt; = emptyList(),&#10;        val filteredUsers: List&lt;User&gt; = emptyList(),&#10;        val query: String = &quot;&quot;,&#10;        val filters: UserFilters = UserFilters(),&#10;        val availableRoles: List&lt;String&gt; = emptyList(),&#10;        val isLoading: Boolean = false,&#10;        val rolesLoading: Boolean = false,&#10;        val error: String? = null&#10;    )&#10;&#10;    private val _uiState = MutableStateFlow(UsersUiState())&#10;    val uiState: StateFlow&lt;UsersUiState&gt; = _uiState.asStateFlow()&#10;&#10;    private val _searchQuery = MutableStateFlow(&quot;&quot;)&#10;&#10;    // Mapa de nombre de rol -&gt; ID para crear usuarios&#10;    private var rolesMap: Map&lt;String, Int&gt; = emptyMap()&#10;&#10;    private val usersRepository: UsersRepository? = context?.let {&#10;        UsersRepository(ApiClient(it))&#10;    }&#10;&#10;    private val rolesRepository: RolesRepository? = context?.let {&#10;        RolesRepository(ApiClient(it))&#10;    }&#10;&#10;    init {&#10;        loadRoles()&#10;        loadUsers()&#10;&#10;        // Búsqueda con debounce de 300ms&#10;        viewModelScope.launch {&#10;            _searchQuery&#10;                .debounce(300)&#10;                .collectLatest { query -&gt;&#10;                    _uiState.update { it.copy(query = query) }&#10;                    applyFilters()&#10;                }&#10;        }&#10;    }&#10;&#10;    private fun loadUsers() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(isLoading = true, error = null) }&#10;&#10;            if (usersRepository != null) {&#10;                // Cargar desde API&#10;                val result = usersRepository.getUsuarios()&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        val users = result.data.map { it.toUser() }&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                users = users,&#10;                                filteredUsers = users,&#10;                                isLoading = false,&#10;                                error = null&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                isLoading = false,&#10;                                error = result.exception.message ?: &quot;Error desconocido&quot;&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Loading -&gt; {&#10;                        // Ya está en loading&#10;                    }&#10;                }&#10;            } else {&#10;                // Fallback: datos hardcodeados si no hay contexto&#10;                val users = listOf(&#10;                    User(&#10;                        id = &quot;1&quot;,&#10;                        username = &quot;admin&quot;,&#10;                        nombre = &quot;Juan&quot;,&#10;                        apellido = &quot;Pérez&quot;,&#10;                        email = &quot;juan.perez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_ADMINISTRADOR&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;2&quot;,&#10;                        username = &quot;auditor1&quot;,&#10;                        nombre = &quot;María&quot;,&#10;                        apellido = &quot;González&quot;,&#10;                        email = &quot;maria.gonzalez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_AUDITOR&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;3&quot;,&#10;                        username = &quot;compras1&quot;,&#10;                        nombre = &quot;Carlos&quot;,&#10;                        apellido = &quot;Rodríguez&quot;,&#10;                        email = &quot;carlos.rodriguez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_COMPRAS&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;4&quot;,&#10;                        username = &quot;ventas1&quot;,&#10;                        nombre = &quot;Ana&quot;,&#10;                        apellido = &quot;Martínez&quot;,&#10;                        email = &quot;ana.martinez@maestranza.cl&quot;,&#10;                        activo = false,&#10;                        roles = listOf(&quot;ROLE_VENTAS&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;5&quot;,&#10;                        username = &quot;supervisor1&quot;,&#10;                        nombre = &quot;Luis&quot;,&#10;                        apellido = &quot;Fernández&quot;,&#10;                        email = &quot;luis.fernandez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_SUPERVISOR&quot;, &quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;6&quot;,&#10;                        username = &quot;empleado1&quot;,&#10;                        nombre = &quot;Patricia&quot;,&#10;                        apellido = &quot;López&quot;,&#10;                        email = &quot;patricia.lopez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;7&quot;,&#10;                        username = &quot;empleado2&quot;,&#10;                        nombre = &quot;Roberto&quot;,&#10;                        apellido = &quot;Silva&quot;,&#10;                        email = &quot;roberto.silva@maestranza.cl&quot;,&#10;                        activo = false,&#10;                        roles = listOf(&quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;8&quot;,&#10;                        username = &quot;compras2&quot;,&#10;                        nombre = &quot;Sofía&quot;,&#10;                        apellido = &quot;Torres&quot;,&#10;                        email = &quot;sofia.torres@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_COMPRAS&quot;, &quot;ROLE_VENTAS&quot;)&#10;                    )&#10;                )&#10;&#10;                _uiState.update {&#10;                    it.copy(&#10;                        users = users,&#10;                        filteredUsers = users,&#10;                        isLoading = false&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun loadRoles() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(rolesLoading = true) }&#10;&#10;            if (rolesRepository != null) {&#10;                // Cargar roles desde API&#10;                val result = rolesRepository.getRoles()&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        // Llenar mapa de roles nombre -&gt; ID&#10;                        rolesMap = result.data.associate { rolDTO -&gt;&#10;                            formatRolName(rolDTO.nombre) to rolDTO.id&#10;                        }&#10;&#10;                        val rolesFormateados = result.data.map { rolDTO -&gt;&#10;                            formatRolName(rolDTO.nombre)&#10;                        }.sorted()&#10;&#10;                        Log.d(&quot;UsersViewModel&quot;, &quot;Roles cargados: $rolesMap&quot;)&#10;&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                availableRoles = rolesFormateados,&#10;                                rolesLoading = false&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        Log.e(&quot;UsersViewModel&quot;, &quot;Error al cargar roles: ${result.exception.message}&quot;)&#10;                        // Usar roles por defecto si falla la carga&#10;                        val rolesDefault = listOf(&#10;                            &quot;ROLE_ADMINISTRADOR&quot;,&#10;                            &quot;ROLE_AUDITOR&quot;,&#10;                            &quot;ROLE_COMPRAS&quot;,&#10;                            &quot;ROLE_VENTAS&quot;,&#10;                            &quot;ROLE_SUPERVISOR&quot;,&#10;                            &quot;ROLE_EMPLEADO&quot;&#10;                        )&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                availableRoles = rolesDefault,&#10;                                rolesLoading = false&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Loading -&gt; {}&#10;                }&#10;            } else {&#10;                // Usar roles por defecto si no hay repositorio&#10;                val rolesDefault = listOf(&#10;                    &quot;ROLE_ADMINISTRADOR&quot;,&#10;                    &quot;ROLE_AUDITOR&quot;,&#10;                    &quot;ROLE_COMPRAS&quot;,&#10;                    &quot;ROLE_VENTAS&quot;,&#10;                    &quot;ROLE_SUPERVISOR&quot;,&#10;                    &quot;ROLE_EMPLEADO&quot;&#10;                )&#10;                _uiState.update {&#10;                    it.copy(&#10;                        availableRoles = rolesDefault,&#10;                        rolesLoading = false&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun formatRolName(rolName: String): String {&#10;        return when {&#10;            rolName.startsWith(&quot;ROLE_&quot;) -&gt; rolName&#10;            else -&gt; &quot;ROLE_${rolName.uppercase()}&quot;&#10;        }&#10;    }&#10;&#10;    fun retry() {&#10;        loadUsers()&#10;    }&#10;&#10;    fun onQueryChange(query: String) {&#10;        _searchQuery.value = query&#10;    }&#10;&#10;    fun onRoleFilterChange(role: String) {&#10;        val currentRoles = _uiState.value.filters.selectedRoles.toMutableSet()&#10;        if (currentRoles.contains(role)) {&#10;            currentRoles.remove(role)&#10;        } else {&#10;            currentRoles.add(role)&#10;        }&#10;&#10;        _uiState.update {&#10;            it.copy(&#10;                filters = it.filters.copy(selectedRoles = currentRoles)&#10;            )&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun onStatusFilterChange(statusFilter: UserStatusFilter) {&#10;        _uiState.update {&#10;            it.copy(&#10;                filters = it.filters.copy(statusFilter = statusFilter)&#10;            )&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun clearFilters() {&#10;        _uiState.update {&#10;            it.copy(&#10;                query = &quot;&quot;,&#10;                filters = UserFilters()&#10;            )&#10;        }&#10;        _searchQuery.value = &quot;&quot;&#10;        applyFilters()&#10;    }&#10;&#10;    private fun applyFilters() {&#10;        val state = _uiState.value&#10;        val filtered = state.users.filter { user -&gt;&#10;            // Filtro de búsqueda&#10;            val matchesQuery = if (state.query.isBlank()) {&#10;                true&#10;            } else {&#10;                user.username.contains(state.query, ignoreCase = true) ||&#10;                user.nombreCompleto.contains(state.query, ignoreCase = true) ||&#10;                user.email.contains(state.query, ignoreCase = true)&#10;            }&#10;&#10;            // Filtro de roles&#10;            val matchesRoles = if (state.filters.selectedRoles.isEmpty()) {&#10;                true&#10;            } else {&#10;                user.roles.any { it in state.filters.selectedRoles }&#10;            }&#10;&#10;            // Filtro de estado&#10;            val matchesStatus = when (state.filters.statusFilter) {&#10;                UserStatusFilter.All -&gt; true&#10;                UserStatusFilter.Active -&gt; user.activo&#10;                UserStatusFilter.Inactive -&gt; !user.activo&#10;            }&#10;&#10;            matchesQuery &amp;&amp; matchesRoles &amp;&amp; matchesStatus&#10;        }&#10;&#10;        _uiState.update { it.copy(filteredUsers = filtered) }&#10;    }&#10;&#10;    fun toggleUserActive(userId: String) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.map { user -&gt;&#10;                if (user.id == userId) {&#10;                    user.copy(activo = !user.activo)&#10;                } else {&#10;                    user&#10;                }&#10;            }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun deleteUser(userId: String) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.filter { it.id != userId }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun addUser(user: User) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users + user&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun createNewUser(&#10;        username: String,&#10;        email: String,&#10;        nombre: String,&#10;        apellido: String,&#10;        password: String,&#10;        roles: List&lt;String&gt;,&#10;        onSuccess: () -&gt; Unit,&#10;        onError: (String) -&gt; Unit&#10;    ) {&#10;        viewModelScope.launch {&#10;            if (usersRepository != null) {&#10;                // Convertir nombres de roles a formato correcto (sin ROLE_ en minúsculas)&#10;                val rolesFormateados = roles.map { roleName -&gt;&#10;                    // Si tiene ROLE_, removerlo&#10;                    roleName.removePrefix(&quot;ROLE_&quot;).lowercase()&#10;                }&#10;&#10;                // Limpiar y formatear datos&#10;                val crearUsuarioDTO = CrearUsuarioDTO(&#10;                    username = username.trim().lowercase(),&#10;                    email = email.trim().lowercase(),&#10;                    nombre = nombre.trim(),&#10;                    apellido = apellido.trim(),&#10;                    password = password.trim(),&#10;                    roles = rolesFormateados&#10;                )&#10;&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;===== CREANDO USUARIO =====&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Username: ${crearUsuarioDTO.username}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Email: ${crearUsuarioDTO.email}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Nombre: ${crearUsuarioDTO.nombre}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Apellido: ${crearUsuarioDTO.apellido}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Password: ${crearUsuarioDTO.password}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Activo: ${crearUsuarioDTO.activo}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Roles: ${crearUsuarioDTO.roles}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;===== FIN PAYLOAD =====&quot;)&#10;&#10;                val result = usersRepository.createUsuario(crearUsuarioDTO)&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        Log.d(&quot;UsersViewModel&quot;, &quot;Usuario creado exitosamente&quot;)&#10;                        // Recargar la lista de usuarios&#10;                        loadUsers()&#10;                        onSuccess()&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        Log.e(&quot;UsersViewModel&quot;, &quot;Error al crear usuario: ${result.exception.message}&quot;)&#10;                        onError(result.exception.message ?: &quot;Error desconocido&quot;)&#10;                    }&#10;                    is Result.Loading -&gt; {}&#10;                }&#10;            } else {&#10;                Log.e(&quot;UsersViewModel&quot;, &quot;Repositorio no disponible&quot;)&#10;                onError(&quot;Repositorio no disponible&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    fun updateUser(updatedUser: User) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.map { user -&gt;&#10;                if (user.id == updatedUser.id) updatedUser else user&#10;            }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun getUserById(id: String): User? {&#10;        return _uiState.value.users.find { it.id == id }&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package cl.duoc.maestranza_v2.viewmodel&#10;&#10;import android.content.Context&#10;import android.util.Log&#10;import androidx.lifecycle.ViewModel&#10;import androidx.lifecycle.viewModelScope&#10;import cl.duoc.maestranza_v2.data.model.User&#10;import cl.duoc.maestranza_v2.data.model.UserFilters&#10;import cl.duoc.maestranza_v2.data.model.UserStatusFilter&#10;import cl.duoc.maestranza_v2.data.model.toUser&#10;import cl.duoc.maestranza_v2.data.model.CrearUsuarioDTO&#10;import cl.duoc.maestranza_v2.data.remote.ApiClient&#10;import cl.duoc.maestranza_v2.data.repository.Result&#10;import cl.duoc.maestranza_v2.data.repository.UsersRepository&#10;import cl.duoc.maestranza_v2.data.repository.RolesRepository&#10;import kotlinx.coroutines.FlowPreview&#10;import kotlinx.coroutines.flow.*&#10;import kotlinx.coroutines.launch&#10;&#10;@OptIn(FlowPreview::class)&#10;class UsersViewModel(context: Context? = null) : ViewModel() {&#10;&#10;    data class UsersUiState(&#10;        val users: List&lt;User&gt; = emptyList(),&#10;        val filteredUsers: List&lt;User&gt; = emptyList(),&#10;        val query: String = &quot;&quot;,&#10;        val filters: UserFilters = UserFilters(),&#10;        val availableRoles: List&lt;String&gt; = emptyList(),&#10;        val isLoading: Boolean = false,&#10;        val rolesLoading: Boolean = false,&#10;        val error: String? = null&#10;    )&#10;&#10;    private val _uiState = MutableStateFlow(UsersUiState())&#10;    val uiState: StateFlow&lt;UsersUiState&gt; = _uiState.asStateFlow()&#10;&#10;    private val _searchQuery = MutableStateFlow(&quot;&quot;)&#10;&#10;    // Mapa de nombre de rol -&gt; ID para crear usuarios&#10;    private var rolesMap: Map&lt;String, Int&gt; = emptyMap()&#10;&#10;    private val usersRepository: UsersRepository? = context?.let {&#10;        UsersRepository(ApiClient(it))&#10;    }&#10;&#10;    private val rolesRepository: RolesRepository? = context?.let {&#10;        RolesRepository(ApiClient(it))&#10;    }&#10;&#10;    init {&#10;        loadRoles()&#10;        loadUsers()&#10;&#10;        // Búsqueda con debounce de 300ms&#10;        viewModelScope.launch {&#10;            _searchQuery&#10;                .debounce(300)&#10;                .collectLatest { query -&gt;&#10;                    _uiState.update { it.copy(query = query) }&#10;                    applyFilters()&#10;                }&#10;        }&#10;    }&#10;&#10;    private fun loadUsers() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(isLoading = true, error = null) }&#10;&#10;            if (usersRepository != null) {&#10;                // Cargar desde API&#10;                val result = usersRepository.getUsuarios()&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        val users = result.data.map { it.toUser() }&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                users = users,&#10;                                filteredUsers = users,&#10;                                isLoading = false,&#10;                                error = null&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                isLoading = false,&#10;                                error = result.exception.message ?: &quot;Error desconocido&quot;&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Loading -&gt; {&#10;                        // Ya está en loading&#10;                    }&#10;                }&#10;            } else {&#10;                // Fallback: datos hardcodeados si no hay contexto&#10;                val users = listOf(&#10;                    User(&#10;                        id = &quot;1&quot;,&#10;                        username = &quot;admin&quot;,&#10;                        nombre = &quot;Juan&quot;,&#10;                        apellido = &quot;Pérez&quot;,&#10;                        email = &quot;juan.perez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_ADMINISTRADOR&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;2&quot;,&#10;                        username = &quot;auditor1&quot;,&#10;                        nombre = &quot;María&quot;,&#10;                        apellido = &quot;González&quot;,&#10;                        email = &quot;maria.gonzalez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_AUDITOR&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;3&quot;,&#10;                        username = &quot;compras1&quot;,&#10;                        nombre = &quot;Carlos&quot;,&#10;                        apellido = &quot;Rodríguez&quot;,&#10;                        email = &quot;carlos.rodriguez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_COMPRAS&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;4&quot;,&#10;                        username = &quot;ventas1&quot;,&#10;                        nombre = &quot;Ana&quot;,&#10;                        apellido = &quot;Martínez&quot;,&#10;                        email = &quot;ana.martinez@maestranza.cl&quot;,&#10;                        activo = false,&#10;                        roles = listOf(&quot;ROLE_VENTAS&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;5&quot;,&#10;                        username = &quot;supervisor1&quot;,&#10;                        nombre = &quot;Luis&quot;,&#10;                        apellido = &quot;Fernández&quot;,&#10;                        email = &quot;luis.fernandez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_SUPERVISOR&quot;, &quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;6&quot;,&#10;                        username = &quot;empleado1&quot;,&#10;                        nombre = &quot;Patricia&quot;,&#10;                        apellido = &quot;López&quot;,&#10;                        email = &quot;patricia.lopez@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;7&quot;,&#10;                        username = &quot;empleado2&quot;,&#10;                        nombre = &quot;Roberto&quot;,&#10;                        apellido = &quot;Silva&quot;,&#10;                        email = &quot;roberto.silva@maestranza.cl&quot;,&#10;                        activo = false,&#10;                        roles = listOf(&quot;ROLE_EMPLEADO&quot;)&#10;                    ),&#10;                    User(&#10;                        id = &quot;8&quot;,&#10;                        username = &quot;compras2&quot;,&#10;                        nombre = &quot;Sofía&quot;,&#10;                        apellido = &quot;Torres&quot;,&#10;                        email = &quot;sofia.torres@maestranza.cl&quot;,&#10;                        activo = true,&#10;                        roles = listOf(&quot;ROLE_COMPRAS&quot;, &quot;ROLE_VENTAS&quot;)&#10;                    )&#10;                )&#10;&#10;                _uiState.update {&#10;                    it.copy(&#10;                        users = users,&#10;                        filteredUsers = users,&#10;                        isLoading = false&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun loadRoles() {&#10;        viewModelScope.launch {&#10;            _uiState.update { it.copy(rolesLoading = true) }&#10;&#10;            if (rolesRepository != null) {&#10;                // Cargar roles desde API&#10;                val result = rolesRepository.getRoles()&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        // Llenar mapa de roles nombre -&gt; ID&#10;                        rolesMap = result.data.associate { rolDTO -&gt;&#10;                            formatRolName(rolDTO.nombre) to rolDTO.id&#10;                        }&#10;&#10;                        val rolesFormateados = result.data.map { rolDTO -&gt;&#10;                            formatRolName(rolDTO.nombre)&#10;                        }.sorted()&#10;&#10;                        Log.d(&quot;UsersViewModel&quot;, &quot;Roles cargados: $rolesMap&quot;)&#10;&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                availableRoles = rolesFormateados,&#10;                                rolesLoading = false&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        Log.e(&quot;UsersViewModel&quot;, &quot;Error al cargar roles: ${result.exception.message}&quot;)&#10;                        // Usar roles por defecto si falla la carga&#10;                        val rolesDefault = listOf(&#10;                            &quot;ROLE_ADMINISTRADOR&quot;,&#10;                            &quot;ROLE_AUDITOR&quot;,&#10;                            &quot;ROLE_COMPRAS&quot;,&#10;                            &quot;ROLE_VENTAS&quot;,&#10;                            &quot;ROLE_SUPERVISOR&quot;,&#10;                            &quot;ROLE_EMPLEADO&quot;&#10;                        )&#10;                        _uiState.update {&#10;                            it.copy(&#10;                                availableRoles = rolesDefault,&#10;                                rolesLoading = false&#10;                            )&#10;                        }&#10;                    }&#10;                    is Result.Loading -&gt; {}&#10;                }&#10;            } else {&#10;                // Usar roles por defecto si no hay repositorio&#10;                val rolesDefault = listOf(&#10;                    &quot;ROLE_ADMINISTRADOR&quot;,&#10;                    &quot;ROLE_AUDITOR&quot;,&#10;                    &quot;ROLE_COMPRAS&quot;,&#10;                    &quot;ROLE_VENTAS&quot;,&#10;                    &quot;ROLE_SUPERVISOR&quot;,&#10;                    &quot;ROLE_EMPLEADO&quot;&#10;                )&#10;                _uiState.update {&#10;                    it.copy(&#10;                        availableRoles = rolesDefault,&#10;                        rolesLoading = false&#10;                    )&#10;                }&#10;            }&#10;        }&#10;    }&#10;&#10;    private fun formatRolName(rolName: String): String {&#10;        return when {&#10;            rolName.startsWith(&quot;ROLE_&quot;) -&gt; rolName&#10;            else -&gt; &quot;ROLE_${rolName.uppercase()}&quot;&#10;        }&#10;    }&#10;&#10;    fun retry() {&#10;        loadUsers()&#10;    }&#10;&#10;    fun onQueryChange(query: String) {&#10;        _searchQuery.value = query&#10;    }&#10;&#10;    fun onRoleFilterChange(role: String) {&#10;        val currentRoles = _uiState.value.filters.selectedRoles.toMutableSet()&#10;        if (currentRoles.contains(role)) {&#10;            currentRoles.remove(role)&#10;        } else {&#10;            currentRoles.add(role)&#10;        }&#10;&#10;        _uiState.update {&#10;            it.copy(&#10;                filters = it.filters.copy(selectedRoles = currentRoles)&#10;            )&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun onStatusFilterChange(statusFilter: UserStatusFilter) {&#10;        _uiState.update {&#10;            it.copy(&#10;                filters = it.filters.copy(statusFilter = statusFilter)&#10;            )&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun clearFilters() {&#10;        _uiState.update {&#10;            it.copy(&#10;                query = &quot;&quot;,&#10;                filters = UserFilters()&#10;            )&#10;        }&#10;        _searchQuery.value = &quot;&quot;&#10;        applyFilters()&#10;    }&#10;&#10;    private fun applyFilters() {&#10;        val state = _uiState.value&#10;        val filtered = state.users.filter { user -&gt;&#10;            // Filtro de búsqueda&#10;            val matchesQuery = if (state.query.isBlank()) {&#10;                true&#10;            } else {&#10;                user.username.contains(state.query, ignoreCase = true) ||&#10;                user.nombreCompleto.contains(state.query, ignoreCase = true) ||&#10;                user.email.contains(state.query, ignoreCase = true)&#10;            }&#10;&#10;            // Filtro de roles&#10;            val matchesRoles = if (state.filters.selectedRoles.isEmpty()) {&#10;                true&#10;            } else {&#10;                user.roles.any { it in state.filters.selectedRoles }&#10;            }&#10;&#10;            // Filtro de estado&#10;            val matchesStatus = when (state.filters.statusFilter) {&#10;                UserStatusFilter.All -&gt; true&#10;                UserStatusFilter.Active -&gt; user.activo&#10;                UserStatusFilter.Inactive -&gt; !user.activo&#10;            }&#10;&#10;            matchesQuery &amp;&amp; matchesRoles &amp;&amp; matchesStatus&#10;        }&#10;&#10;        _uiState.update { it.copy(filteredUsers = filtered) }&#10;    }&#10;&#10;    fun toggleUserActive(userId: String) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.map { user -&gt;&#10;                if (user.id == userId) {&#10;                    user.copy(activo = !user.activo)&#10;                } else {&#10;                    user&#10;                }&#10;            }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun deleteUser(userId: String) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.filter { it.id != userId }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun addUser(user: User) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users + user&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun createNewUser(&#10;        username: String,&#10;        email: String,&#10;        nombre: String,&#10;        apellido: String,&#10;        password: String,&#10;        roles: List&lt;String&gt;,&#10;        onSuccess: () -&gt; Unit,&#10;        onError: (String) -&gt; Unit&#10;    ) {&#10;        viewModelScope.launch {&#10;            if (usersRepository != null) {&#10;                // Convertir nombres de roles a formato correcto (sin ROLE_ en minúsculas)&#10;                val rolesFormateados = roles.map { roleName -&gt;&#10;                    // Si tiene ROLE_, removerlo&#10;                    roleName.removePrefix(&quot;ROLE_&quot;).lowercase()&#10;                }&#10;&#10;                // Limpiar y formatear datos&#10;                val crearUsuarioDTO = CrearUsuarioDTO(&#10;                    username = username.trim().lowercase(),&#10;                    email = email.trim().lowercase(),&#10;                    nombre = nombre.trim(),&#10;                    apellido = apellido.trim(),&#10;                    password = password.trim(),&#10;                    roles = rolesFormateados&#10;                )&#10;&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;===== CREANDO USUARIO =====&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Username: ${crearUsuarioDTO.username}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Email: ${crearUsuarioDTO.email}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Nombre: ${crearUsuarioDTO.nombre}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Apellido: ${crearUsuarioDTO.apellido}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Password: ${crearUsuarioDTO.password}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;Roles: ${crearUsuarioDTO.roles}&quot;)&#10;                Log.d(&quot;UsersViewModel&quot;, &quot;===== FIN PAYLOAD =====&quot;)&#10;&#10;                val result = usersRepository.createUsuario(crearUsuarioDTO)&#10;                when (result) {&#10;                    is Result.Success -&gt; {&#10;                        Log.d(&quot;UsersViewModel&quot;, &quot;Usuario creado exitosamente&quot;)&#10;                        // Recargar la lista de usuarios&#10;                        loadUsers()&#10;                        onSuccess()&#10;                    }&#10;                    is Result.Error -&gt; {&#10;                        Log.e(&quot;UsersViewModel&quot;, &quot;Error al crear usuario: ${result.exception.message}&quot;)&#10;                        onError(result.exception.message ?: &quot;Error desconocido&quot;)&#10;                    }&#10;                    is Result.Loading -&gt; {}&#10;                }&#10;            } else {&#10;                Log.e(&quot;UsersViewModel&quot;, &quot;Repositorio no disponible&quot;)&#10;                onError(&quot;Repositorio no disponible&quot;)&#10;            }&#10;        }&#10;    }&#10;&#10;    fun updateUser(updatedUser: User) {&#10;        _uiState.update { state -&gt;&#10;            val updatedUsers = state.users.map { user -&gt;&#10;                if (user.id == updatedUser.id) updatedUser else user&#10;            }&#10;            state.copy(users = updatedUsers)&#10;        }&#10;        applyFilters()&#10;    }&#10;&#10;    fun getUserById(id: String): User? {&#10;        return _uiState.value.users.find { it.id == id }&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>